generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model User {
  id            String         @id @default(cuid())
  name          String?
  email         String?        @unique
  emailVerified DateTime?
  image         String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  password      String?
  accounts      Account[]
  leagues       League[]       @relation("LeagueCommissioner")
  leagueMembers LeagueMember[]
  teams         Team[]
}

model League {
  id             String           @id @default(cuid())
  name           String
  commissionerId String
  seasonStart    DateTime
  seasonEnd      DateTime?
  totalWeeks     Int              @default(12)
  draftStatus    String           @default("NOT_STARTED")
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  draftPicks     DraftPick[]
  invitations    Invitation[]
  commissioner   User             @relation("LeagueCommissioner", fields: [commissionerId], references: [id])
  activities     LeagueActivity[]
  members        LeagueMember[]
  matchups       Matchup[]
  teams          Team[]
}

model DraftPick {
  id           String     @id @default(cuid())
  leagueId     String
  teamId       String
  legislatorId String
  pickNumber   Int
  round        Int
  createdAt    DateTime   @default(now())
  league       League     @relation(fields: [leagueId], references: [id])
  legislator   Legislator @relation(fields: [legislatorId], references: [id])
  team         Team       @relation(fields: [teamId], references: [id])

  @@unique([leagueId, pickNumber])
  @@unique([leagueId, legislatorId])
}

model DraftPreference {
  id           String     @id @default(cuid())
  teamId       String
  legislatorId String
  rank         Int
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  legislator   Legislator @relation(fields: [legislatorId], references: [id])
  team         Team       @relation(fields: [teamId], references: [id])

  @@unique([teamId, legislatorId])
  @@unique([teamId, rank])
}

model Invitation {
  id        String   @id @default(cuid())
  email     String
  leagueId  String
  status    String   @default("PENDING")
  token     String   @unique @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  league    League   @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  @@unique([email, leagueId])
}

model LeagueMember {
  id       String @id @default(cuid())
  userId   String
  leagueId String
  league   League @relation(fields: [leagueId], references: [id])
  user     User   @relation(fields: [userId], references: [id])

  @@unique([userId, leagueId])
}

model Team {
  id                 String            @id @default(cuid())
  name               String
  ownerId            String
  leagueId           String
  wins               Int               @default(0)
  losses             Int               @default(0)
  ties               Int               @default(0)
  benchLegislatorIds String            @default("")
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  draftPicks         DraftPick[]
  preferences        DraftPreference[]
  activities         LeagueActivity[]
  homeMatchups       Matchup[]         @relation("Team1Matchups")
  awayMatchups       Matchup[]         @relation("Team2Matchups")
  league             League            @relation(fields: [leagueId], references: [id])
  owner              User              @relation(fields: [ownerId], references: [id])
  legislators        Legislator[]      @relation("LegislatorToTeam")
}

model Legislator {
  id                String            @id @default(cuid())
  externalId        String?           @unique
  nameCh            String
  nameEn            String?
  party             String
  region            String?
  sex               String?
  picUrl            String?
  leaveFlag         String?
  leaveDate         String?
  errorFlag         String?
  errorReason       String?
  areaName          String?
  leaveReason       String?
  committee         String?
  onboardDate       String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  draftPicks        DraftPick[]
  preferences       DraftPreference[]
  activitiesAdded   LeagueActivity[]  @relation("LegislatorAdded")
  activitiesDropped LeagueActivity[]  @relation("LegislatorDropped")
  scores            Score[]
  teams             Team[]            @relation("LegislatorToTeam")
}

model Score {
  id             String     @id @default(cuid())
  legislatorId   String
  date           DateTime
  points         Float
  description    String
  category       String
  billNumber     String?
  billTitle      String?
  votePosition   String?
  rollcallNumber String?
  metadata       String?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  legislator     Legislator @relation(fields: [legislatorId], references: [id])

  @@index([legislatorId, date])
  @@index([legislatorId, category])
}

model Matchup {
  id         String   @id @default(cuid())
  leagueId   String
  week       Int
  weekStart  DateTime
  team1Id    String
  team2Id    String?
  team1Score Float?
  team2Score Float?
  winnerId   String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  league     League   @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  team1      Team     @relation("Team1Matchups", fields: [team1Id], references: [id])
  team2      Team?    @relation("Team2Matchups", fields: [team2Id], references: [id])

  @@unique([leagueId, week, team1Id])
  @@index([leagueId, week])
}

model LeagueActivity {
  id                  String      @id @default(cuid())
  leagueId            String
  teamId              String
  type                String
  legislatorAddedId   String?
  legislatorDroppedId String?
  message             String
  createdAt           DateTime    @default(now())
  league              League      @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  legislatorAdded     Legislator? @relation("LegislatorAdded", fields: [legislatorAddedId], references: [id])
  legislatorDropped   Legislator? @relation("LegislatorDropped", fields: [legislatorDroppedId], references: [id])
  team                Team        @relation(fields: [teamId], references: [id])

  @@index([leagueId, createdAt])
}
