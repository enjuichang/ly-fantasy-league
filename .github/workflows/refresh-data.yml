name: Refresh Data

on:
  schedule:
    - cron: '0 0 * * *' # Runs every day at midnight UTC
  workflow_dispatch: # Allows manual triggering

jobs:
  refresh:
    runs-on: ubuntu-latest
    steps:
      - name: Sync Legislators
        run: |
          curl -X POST "${{ secrets.APP_URL }}/api/legislators/sync" \
          -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
          --fail

      # PROPOSE BILLS - Split into 12 batches of 10 to avoid timeout (Total 120)
      - name: Sync Propose Bills (Batch 1/12)
        run: |
          curl -X GET "${{ secrets.APP_URL }}/api/refresh-data?type=propose&limit=10&offset=0" \
          -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
          --fail

      - name: Sync Propose Bills (Batch 2/12)
        run: |
          curl -X GET "${{ secrets.APP_URL }}/api/refresh-data?type=propose&limit=10&offset=10" \
          -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
          --fail

      - name: Sync Propose Bills (Batch 3/12)
        run: |
          curl -X GET "${{ secrets.APP_URL }}/api/refresh-data?type=propose&limit=10&offset=20" \
          -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
          --fail

      - name: Sync Propose Bills (Batch 4/12)
        run: |
          curl -X GET "${{ secrets.APP_URL }}/api/refresh-data?type=propose&limit=10&offset=30" \
          -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
          --fail

      - name: Sync Propose Bills (Batch 5/12)
        run: |
          curl -X GET "${{ secrets.APP_URL }}/api/refresh-data?type=propose&limit=10&offset=40" \
          -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
          --fail

      - name: Sync Propose Bills (Batch 6/12)
        run: |
          curl -X GET "${{ secrets.APP_URL }}/api/refresh-data?type=propose&limit=10&offset=50" \
          -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
          --fail

      - name: Sync Propose Bills (Batch 7/12)
        run: |
          curl -X GET "${{ secrets.APP_URL }}/api/refresh-data?type=propose&limit=10&offset=60" \
          -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
          --fail

      - name: Sync Propose Bills (Batch 8/12)
        run: |
          curl -X GET "${{ secrets.APP_URL }}/api/refresh-data?type=propose&limit=10&offset=70" \
          -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
          --fail

      - name: Sync Propose Bills (Batch 9/12)
        run: |
          curl -X GET "${{ secrets.APP_URL }}/api/refresh-data?type=propose&limit=10&offset=80" \
          -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
          --fail

      - name: Sync Propose Bills (Batch 10/12)
        run: |
          curl -X GET "${{ secrets.APP_URL }}/api/refresh-data?type=propose&limit=10&offset=90" \
          -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
          --fail

      - name: Sync Propose Bills (Batch 11/12)
        run: |
          curl -X GET "${{ secrets.APP_URL }}/api/refresh-data?type=propose&limit=10&offset=100" \
          -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
          --fail

      - name: Sync Propose Bills (Batch 12/12)
        run: |
          curl -X GET "${{ secrets.APP_URL }}/api/refresh-data?type=propose&limit=10&offset=110" \
          -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
          --fail

      # ROLLCALL VOTES - Split into 4 batches of 5 (Total 20), looking back 14 days
      - name: Sync Rollcall Votes (Batch 1/4 - 5 votes)
        run: |
          curl -X GET "${{ secrets.APP_URL }}/api/refresh-data?type=rollcall&rollcall_limit=5&rollcall_offset=0&rollcall_lookback_days=14" \
          -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
          --fail

      - name: Sync Rollcall Votes (Batch 2/4 - 5 votes)
        run: |
          curl -X GET "${{ secrets.APP_URL }}/api/refresh-data?type=rollcall&rollcall_limit=5&rollcall_offset=5&rollcall_lookback_days=14" \
          -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
          --fail

      - name: Sync Rollcall Votes (Batch 3/4 - 5 votes)
        run: |
          curl -X GET "${{ secrets.APP_URL }}/api/refresh-data?type=rollcall&rollcall_limit=5&rollcall_offset=10&rollcall_lookback_days=14" \
          -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
          --fail

      - name: Sync Rollcall Votes (Batch 4/4 - 5 votes)
        run: |
          curl -X GET "${{ secrets.APP_URL }}/api/refresh-data?type=rollcall&rollcall_limit=5&rollcall_offset=15&rollcall_lookback_days=14" \
          -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
          --fail

      - name: Sync Cosign Bills
        run: |
          curl -X GET "${{ secrets.APP_URL }}/api/refresh-data?type=cosign" \
          -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
          --fail

      - name: Sync Maverick Scores
        run: |
          curl -X GET "${{ secrets.APP_URL }}/api/refresh-data?type=maverick" \
          -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
          --fail
